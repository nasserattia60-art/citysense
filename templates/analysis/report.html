{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CitySense Report</title>
    <link rel="stylesheet" href="{% static 'css/base/all.min.css' %}">
    <link rel="stylesheet" href="{% static 'css/base/base.css' %}">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .report-wrapper {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .report-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .report-header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .report-header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .report-header .generated-date {
            font-size: 0.9em;
            opacity: 0.8;
            margin-top: 10px;
        }

        .report-content {
            padding: 40px;
        }

        .section {
            margin-bottom: 40px;
            border-bottom: 1px solid #eee;
            padding-bottom: 40px;
        }

        .section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .section-title {
            font-size: 1.8em;
            color: #667eea;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .section-subtitle {
            font-size: 1.3em;
            color: #333;
            margin-bottom: 15px;
            font-weight: 500;
        }

        .overview-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 20px;
        }

        .overview-item {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .overview-item h3 {
            color: #667eea;
            font-size: 0.9em;
            text-transform: uppercase;
            margin-bottom: 10px;
            letter-spacing: 1px;
        }

        .overview-item p {
            color: #555;
            line-height: 1.8;
        }

        .scores-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .score-card {
            background: white;
            border: 2px solid #eee;
            border-radius: 8px;
            padding: 25px;
            text-align: center;
            transition: all 0.3s;
        }

        .score-card:hover {
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.15);
            border-color: #667eea;
        }

        .score-label {
            font-size: 0.9em;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .score-value {
            font-size: 3em;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .score-subtext {
            font-size: 0.9em;
            color: #999;
            margin-top: 10px;
        }

        .conditions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .condition-card {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        .condition-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .condition-value {
            font-size: 1.4em;
            color: #667eea;
            font-weight: 700;
        }

        .condition-description {
            font-size: 0.9em;
            color: #999;
            margin-top: 5px;
        }

        .weather-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .weather-item {
            background: white;
            border: 2px solid #eee;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .weather-label {
            font-size: 0.85em;
            color: #999;
            text-transform: uppercase;
            margin-bottom: 8px;
            letter-spacing: 1px;
        }

        .weather-value {
            font-size: 2em;
            font-weight: 700;
            color: #333;
        }

        .weather-unit {
            font-size: 0.7em;
            color: #999;
            margin-left: 5px;
        }

        .risk-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .risk-card {
            padding: 25px;
            border-radius: 8px;
            border-left: 5px solid;
            background: #f8f9fa;
        }

        .risk-card.green {
            border-left-color: #27ae60;
            background: rgba(39, 174, 96, 0.05);
        }

        .risk-card.orange {
            border-left-color: #f39c12;
            background: rgba(243, 156, 18, 0.05);
        }

        .risk-card.red {
            border-left-color: #e74c3c;
            background: rgba(231, 76, 60, 0.05);
        }

        .risk-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }

        .risk-status {
            font-size: 1.3em;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .risk-status.green { color: #27ae60; }
        .risk-status.orange { color: #f39c12; }
        .risk-status.red { color: #e74c3c; }

        .risk-details {
            font-size: 0.9em;
            color: #666;
            line-height: 1.8;
        }

        .map-section {
            margin: 40px 0;
        }

        #map {
            width: 100%;
            height: 400px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .map-hidden {
            display: none;
        }

        .summary-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 8px;
            font-size: 1.1em;
            line-height: 1.9;
            font-weight: 500;
        }

        .attractions-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .attraction-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #667eea;
            font-size: 0.95em;
            color: #555;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px 10px;
            }

            .report-header {
                padding: 30px 20px;
            }

            .report-header h1 {
                font-size: 1.8em;
            }

            .report-content {
                padding: 20px;
            }

            .overview-grid {
                grid-template-columns: 1fr;
            }

            .section {
                padding-bottom: 30px;
                margin-bottom: 30px;
            }

            .scores-grid,
            .weather-grid,
            .risk-grid {
                grid-template-columns: 1fr;
            }

            #map {
                height: 300px;
            }
        }

        .na-value {
            color: #999;
            font-style: italic;
        }

        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        main {
            flex: 1;
        }
    </style>
</head>
<body>
    {% include 'base/header.html' %}
    
    <main>
        <div class="container">
            <div class="report-wrapper">
                <div class="report-header">
                    <h1 id="cityName">Loading...</h1>
                    <p id="cityOverview"></p>
                    <div class="generated-date" id="generatedDate"></div>
                </div>

                <div class="report-content">

                <div class="section">
                    <h2 class="section-title">City Overview</h2>
                    <div class="overview-grid">
                        <div class="overview-item">
                            <h3>Coordinates</h3>
                            <p id="coordinates">N/A</p>
                        </div>
                        <div class="overview-item">
                            <h3>Cultural Notes</h3>
                            <p id="culturalNotes">N/A</p>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h2 class="section-title">Key Scores</h2>
                    <div class="scores-grid">
                        <div class="score-card">
                            <div class="score-label">AI Livability Score</div>
                            <div class="score-value" id="aiScore">N/A</div>
                            <div class="score-subtext">/100</div>
                        </div>
                        <div class="score-card">
                            <div class="score-label">Safety Score</div>
                            <div class="score-value" id="safetyScore">N/A</div>
                            <div class="score-subtext">/10</div>
                        </div>
                        <div class="score-card">
                            <div class="score-label">Tourism Score</div>
                            <div class="score-value" id="tourismScore">N/A</div>
                            <div class="score-subtext">/100</div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h2 class="section-title">Living Conditions</h2>
                    <div class="conditions-grid">
                        <div class="condition-card">
                            <div class="condition-label">Noise Level</div>
                            <div class="condition-value" id="noiseLevel">N/A</div>
                            <div class="condition-description">Ambient noise pollution assessment</div>
                        </div>
                        <div class="condition-card">
                            <div class="condition-label">Rent Level</div>
                            <div class="condition-value" id="rentLevel">N/A</div>
                            <div class="condition-description">Housing cost relative to region</div>
                        </div>
                        <div class="condition-card">
                            <div class="condition-label">Water Quality</div>
                            <div class="condition-value" id="waterQuality">N/A</div>
                            <div class="condition-description">Water supply safety & purity</div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h2 class="section-title">Weather Summary</h2>
                    
                    <h3 class="section-subtitle">Current Conditions</h3>
                    <div class="weather-grid" id="currentWeatherGrid">
                        <div class="weather-item">
                            <div class="weather-label">Apparent Temperature</div>
                            <div class="weather-value" id="apparentTemp">N/A<span class="weather-unit">¬∞C</span></div>
                        </div>
                        <div class="weather-item">
                            <div class="weather-label">Humidity</div>
                            <div class="weather-value" id="humidity">N/A<span class="weather-unit">%</span></div>
                        </div>
                        <div class="weather-item">
                            <div class="weather-label">Wind Speed</div>
                            <div class="weather-value" id="windSpeed">N/A<span class="weather-unit">km/h</span></div>
                        </div>
                    </div>

                    <h3 class="section-subtitle">14-Day Averages</h3>
                    <div class="weather-grid" id="averageWeatherGrid">
                        <div class="weather-item">
                            <div class="weather-label">Average Temperature</div>
                            <div class="weather-value" id="avgTemp">N/A<span class="weather-unit">¬∞C</span></div>
                        </div>
                        <div class="weather-item">
                            <div class="weather-label">Minimum Temperature</div>
                            <div class="weather-value" id="minTemp">N/A<span class="weather-unit">¬∞C</span></div>
                        </div>
                        <div class="weather-item">
                            <div class="weather-label">Maximum Temperature</div>
                            <div class="weather-value" id="maxTemp">N/A<span class="weather-unit">¬∞C</span></div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h2 class="section-title">Risk & Alerts</h2>

                    <h3 class="section-subtitle">Human Feeling Index</h3>
                    <div class="risk-grid">
                        <div class="risk-card" id="feelingCard">
                            <div class="risk-title">Comfort Assessment</div>
                            <div class="risk-status" id="feelingStatus">N/A</div>
                            <div class="risk-details" id="feelingDetails">N/A</div>
                        </div>
                    </div>

                    <h3 class="section-subtitle" style="margin-top: 30px;">Snow Risk Analysis</h3>
                    <div class="risk-grid">
                        <div class="risk-card" id="snowCard">
                            <div class="risk-title">Snowfall Risk</div>
                            <div class="risk-status" id="snowStatus">N/A</div>
                            <div class="risk-details" id="snowDetails">N/A</div>
                        </div>
                    </div>

                    <h3 class="section-subtitle" style="margin-top: 30px;">Weather Risk Engine</h3>
                    <div class="risk-grid">
                        <div class="risk-card" id="weatherCard">
                            <div class="risk-title">Severe Weather Risk</div>
                            <div class="risk-status" id="weatherStatus">N/A</div>
                            <div class="risk-details" id="weatherDetails">N/A</div>
                        </div>
                    </div>
                </div>

                <div class="section map-section" id="mapSection">
                    <h2 class="section-title">Location Map</h2>
                    <div id="map"></div>
                </div>

                <div class="section" id="attractionsSection">
                    <h2 class="section-title">Top Attractions & Landmarks</h2>
                    
                    <h3 class="section-subtitle">Historical Landmarks</h3>
                    <div class="attractions-list" id="landmarksList"></div>

                    <h3 class="section-subtitle" style="margin-top: 25px;">Top Attractions</h3>
                    <div class="attractions-list" id="attractionsList"></div>
                </div>

                <div class="section">
                    <h2 class="section-title">AI Summary</h2>
                    <div class="summary-box" id="summaryText">
                        N/A
                    </div>
                </div>

            </div>
        </div>
    </div>
    </main>

    {% include 'base/footer.html' %}

    <script src="{% static 'js/base/base.js' %}"></script>
    <script>
        // Inject Django data into JavaScript
        {% autoescape off %}
        window.CITYSENSE_DATA = {
            aiAnalysis: {
                city_name: "{{ report.location.address }}",
                overview: "{{ report.location.address }} Analysis",
                cultural_notes: "Location analysis report",
                ai_score: "{{ report.ai_score }}",
                safety_score: {{ report.safety_score|default:"null" }},
                tourism_score: "75",
                noise_level: "{{ report.noise_level }}",
                rent_level: "{{ report.rent_level }}",
                water_quality: "{{ report.water_quality }}",
                historical_landmarks: ["Historic site 1", "Historic site 2"],
                top_attractions: ["Attraction 1", "Attraction 2"],
                summary: "{{ report.ai_summary }}"
            },
            weatherData: {
                location: {
                    latitude: {{ report.location.latitude|default:"null" }},
                    longitude: {{ report.location.longitude|default:"null" }}
                },
                human_feeling_index: {
                    apparent_temperature_C: {{ report.temperature|default:"null" }},
                    humidity_percent: 65,
                    wind_speed_kmh: {{ report.windspeed|default:"null" }},
                    status: "COMFORTABLE"
                },
                statistics: {
                    avg_temperature_14_days_C: {{ report.temperature|default:"null" }},
                    min_14_days_C: {{ report.temperature|default:"null" }},
                    max_14_days_C: {{ report.temperature|default:"null" }}
                },
                snow_analysis: {
                    risk_level: "LOW",
                    total_snow_cm: 0,
                    max_snow_depth_cm: 0,
                    freezing_level_min_m: 3000
                },
                weather_risk_engine: {
                    risk_level: "{{ report.weather_code|default:'LOW' }}",
                    min_visibility_m: 10000,
                    max_wind_gusts_kmh: {{ report.windspeed|default:"0" }},
                    min_pressure_hpa: 1013
                }
            }
        };
        {% endautoescape %}

        const reportData = {
            aiAnalysis: window.CITYSENSE_DATA.aiAnalysis,
            weatherData: window.CITYSENSE_DATA.weatherData,
            hasError: false,
            errorMessage: ""
        };

        function getOrDefault(value, defaultValue = "N/A") {
            return (value === null || value === undefined || value === "") ? defaultValue : value;
        }

        function formatNumber(value, decimals = 2) {
            if (value === null || value === undefined) return "N/A";
            return parseFloat(value).toFixed(decimals);
        }

        function colorizeRiskStatus(statusText) {
            if (!statusText) return "gray";
            const upper = statusText.toUpperCase();
            if (upper.includes("LOW") || upper.includes("COMFORTABLE")) return "green";
            if (upper.includes("MEDIUM") || upper.includes("FREEZING") || upper.includes("DANGEROUS")) return "orange";
            if (upper.includes("HIGH") || upper.includes("EXTREME")) return "red";
            return "gray";
        }

        function renderHeader() {
            const ai = reportData.aiAnalysis || {};
            const cityName = getOrDefault(ai.city_name, "Unknown City");
            const overview = getOrDefault(ai.overview, "");
            
            document.getElementById("cityName").textContent = cityName;
            document.getElementById("cityOverview").textContent = overview;
            document.getElementById("generatedDate").textContent = `Generated on ${new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}`;
        }

        function renderCityOverview() {
            const ai = reportData.aiAnalysis || {};
            const weather = reportData.weatherData || {};

            const lat = getOrDefault(weather.location?.latitude);
            const lon = getOrDefault(weather.location?.longitude);
            const coordText = (lat !== "N/A" && lon !== "N/A") ? `${lat}, ${lon}` : "N/A";
            document.getElementById("coordinates").textContent = coordText;

            const cultural = getOrDefault(ai.cultural_notes, "No cultural information available.");
            document.getElementById("culturalNotes").textContent = cultural;
        }

        function renderScores() {
            const ai = reportData.aiAnalysis || {};
            
            const aiScore = getOrDefault(ai.ai_score);
            const safetyScore = getOrDefault(ai.safety_score);
            const tourismScore = getOrDefault(ai.tourism_score);

            document.getElementById("aiScore").textContent = aiScore;
            document.getElementById("safetyScore").textContent = formatNumber(safetyScore, 1);
            document.getElementById("tourismScore").textContent = tourismScore;
        }

        function renderLivingConditions() {
            const ai = reportData.aiAnalysis || {};
            
            document.getElementById("noiseLevel").textContent = getOrDefault(ai.noise_level);
            document.getElementById("rentLevel").textContent = getOrDefault(ai.rent_level);
            document.getElementById("waterQuality").textContent = getOrDefault(ai.water_quality);
        }

        function renderWeather() {
            const weather = reportData.weatherData || {};

            const current = weather.human_feeling_index || {};
            document.getElementById("apparentTemp").innerHTML = formatNumber(current.apparent_temperature_C) + '<span class="weather-unit">¬∞C</span>';
            document.getElementById("humidity").innerHTML = getOrDefault(current.humidity_percent) + '<span class="weather-unit">%</span>';
            document.getElementById("windSpeed").innerHTML = formatNumber(current.wind_speed_kmh) + '<span class="weather-unit">km/h</span>';

            const stats = weather.statistics || {};
            document.getElementById("avgTemp").innerHTML = formatNumber(stats.avg_temperature_14_days_C) + '<span class="weather-unit">¬∞C</span>';
            document.getElementById("minTemp").innerHTML = formatNumber(stats.min_14_days_C) + '<span class="weather-unit">¬∞C</span>';
            document.getElementById("maxTemp").innerHTML = formatNumber(stats.max_14_days_C) + '<span class="weather-unit">¬∞C</span>';
        }

        function renderRiskAnalysis() {
            const weather = reportData.weatherData || {};

            const feeling = weather.human_feeling_index || {};
            const feelingColor = colorizeRiskStatus(feeling.status);
            const feelingCard = document.getElementById("feelingCard");
            feelingCard.className = `risk-card ${feelingColor}`;
            document.getElementById("feelingStatus").className = `risk-status ${feelingColor}`;
            document.getElementById("feelingStatus").textContent = getOrDefault(feeling.status, "UNKNOWN");
            document.getElementById("feelingDetails").innerHTML = `
                Apparent Temperature: ${formatNumber(feeling.apparent_temperature_C)}¬∞C<br>
                Humidity: ${getOrDefault(feeling.humidity_percent)}%<br>
                Wind Speed: ${formatNumber(feeling.wind_speed_kmh)} km/h
            `;

            const snow = weather.snow_analysis || {};
            const snowColor = colorizeRiskStatus(snow.risk_level);
            const snowCard = document.getElementById("snowCard");
            snowCard.className = `risk-card ${snowColor}`;
            document.getElementById("snowStatus").className = `risk-status ${snowColor}`;
            document.getElementById("snowStatus").textContent = getOrDefault(snow.risk_level, "UNKNOWN");
            document.getElementById("snowDetails").innerHTML = `
                Total Snowfall (14 days): ${formatNumber(snow.total_snow_cm)} cm<br>
                Max Snow Depth: ${formatNumber(snow.max_snow_depth_cm)} cm<br>
                Min Freezing Level: ${getOrDefault(snow.freezing_level_min_m)} m
            `;

            const weatherRisk = weather.weather_risk_engine || {};
            const riskColor = colorizeRiskStatus(weatherRisk.risk_level);
            const weatherCard = document.getElementById("weatherCard");
            weatherCard.className = `risk-card ${riskColor}`;
            document.getElementById("weatherStatus").className = `risk-status ${riskColor}`;
            document.getElementById("weatherStatus").textContent = getOrDefault(weatherRisk.risk_level, "UNKNOWN");
            document.getElementById("weatherDetails").innerHTML = `
                Min Visibility: ${formatNumber(weatherRisk.min_visibility_m)} m<br>
                Max Wind Gusts: ${formatNumber(weatherRisk.max_wind_gusts_kmh)} km/h<br>
                Min Pressure: ${formatNumber(weatherRisk.min_pressure_hpa)} hPa
            `;
        }

        function renderAttractions() {
            const ai = reportData.aiAnalysis || {};

            const landmarks = ai.historical_landmarks || [];
            const landmarksList = document.getElementById("landmarksList");
            if (Array.isArray(landmarks) && landmarks.length > 0) {
                landmarksList.innerHTML = landmarks.map(item => 
                    `<div class="attraction-item">üìç ${getOrDefault(item)}</div>`
                ).join("");
            } else {
                landmarksList.innerHTML = '<div class="attraction-item">No landmarks data available</div>';
            }

            const attractions = ai.top_attractions || [];
            const attractionsList = document.getElementById("attractionsList");
            if (Array.isArray(attractions) && attractions.length > 0) {
                attractionsList.innerHTML = attractions.map(item => 
                    `<div class="attraction-item">‚≠ê ${getOrDefault(item)}</div>`
                ).join("");
            } else {
                attractionsList.innerHTML = '<div class="attraction-item">No attractions data available</div>';
            }
        }

        function renderSummary() {
            const ai = reportData.aiAnalysis || {};
            const summary = getOrDefault(ai.summary, "No summary available.");
            document.getElementById("summaryText").textContent = summary;
        }

        function renderMap() {
            const weather = reportData.weatherData || {};
            const ai = reportData.aiAnalysis || {};

            const lat = weather.location?.latitude;
            const lon = weather.location?.longitude;
            const cityName = getOrDefault(ai.city_name, "Location");

            if (!lat || !lon) {
                document.getElementById("mapSection").style.display = "none";
                return;
            }

            try {
                const map = L.map("map").setView([lat, lon], 13);
                L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                    attribution: "&copy; OpenStreetMap contributors",
                    maxZoom: 19
                }).addTo(map);

                L.marker([lat, lon])
                    .addTo(map)
                    .bindPopup(`<b>${cityName}</b><br>Lat: ${lat.toFixed(4)}, Lon: ${lon.toFixed(4)}`)
                    .openPopup();

            } catch (err) {
                console.error("Map rendering error:", err);
                document.getElementById("mapSection").style.display = "none";
            }
        }

        // Initialize report rendering
        document.addEventListener('DOMContentLoaded', function() {
            try {
                renderHeader();
                renderCityOverview();
                renderScores();
                renderLivingConditions();
                renderWeather();
                renderRiskAnalysis();
                renderAttractions();
                renderSummary();
                renderMap();
            } catch (err) {
                console.error("Rendering error:", err);
            }
        });

        window.CitySenseReport = {
            getData: () => reportData
        };
    </script>

    {% if user.is_authenticated %}
        <script>
            window.USER_IS_AUTHENTICATED = true;
        </script>
    {% else %}
        <script>
            window.USER_IS_AUTHENTICATED = false;
        </script>
    {% endif %}
    </main>
</body>
</html>
